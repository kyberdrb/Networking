Adblocking Proxy: pfSense + Squid + SquidGuard

pfSense provides a centralized solution to control network traffic.
pfSense had been installed into VirtualBox. The computer, as well as the virtual machine
had only one network card.

####################################################
pfSense
####################################################
  Download pfSense CD ISO: 
    https://www.pfsense.org/download/
    Choose: "File Type" = Install, "Architecture" = AMD64 (64-bit), "Mirror" = Frankfurt, Germany
  
  ----------------------------------
  Create virtual machine
  ----------------------------------
    All availible number of CPUs, >512MB RAM, 10GB HDD, one or two network cards (if you want
    only proxy or firewall capability for LAN as well). For VirtualBox, enable: "System->Processor->Enable PAE/NX"
    and for network adapters in "Network" set it as "Attached to:" = Bridged Adapter, then go to "Advanced->Promiscuous Mode" 
    and set it to "Allow All". Insert downloaded ISO image into the virtual drive.
    
  ----------------------------------
  Install pfSense
  ----------------------------------
    Run virtual machine. You will see a bootloader. Wait. After a while you will see a "Configure Console"
    dialog. Accept default options: "Accept these Settings". Then choose "Quick/Easy Install". Then choose
    "OK". Wait. Then choose "Standard Kernel". Then choose "Reboot". Wait. When the "Configure Console"
    dialog appears, in the menubar click on "Devices->CD/DVD devices->Remove disk from virtual drive".
    Choose "Force Unmount". Then in the menubar click on "Machine->Reset". The pfSense is now installed,
    now we need to configure it.
  
  ----------------------------------
  Configure pfSense
  ----------------------------------
    Continuing in the first boot process, you will be prompted with several questions:
    Should VLANs be set up now? n
    Enter the WAN interface name or 'a' for auto-detection (em0 or a): em0
    Enter the LAN interface name or 'a' for auto-detection: <press Enter>
    Do you want to proceed?: y
    Wait a moment, necessary services will be started. After that, you will be
    greated with a main menu and IP address. You should enter this address to 
    the internet browser, which will reveal pfSense web interface, in which the
    majority of things can be configured.
  
  ----------------------------------
  Enable SSH
  ----------------------------------
    pfSense can be easily troubleshooted from the web GUI, but it's always better
    to have SSH access to diagnose problems at deeper level.
    Under "System->Advanced" in category "Secure Shell" enable "Secure Shell Server".
    Click on "Save" button on the bottom of the page.
    Wait, until the page finishes loading. You can then log in via SSH with the same
    credentials as for the GUI.
    	
####################################################
SQUID
####################################################
  Squid is a proxy server which we will use to monitor network traffic.

----------------------------------
Install Squid
----------------------------------
  "System->Package Manager->Availible Packages" and in the "Search Term" box enter "squid"
  and press Enter. Then install package "squid". Confirm.

----------------------------------
Configure Squid
----------------------------------
>>Local Cache
  First of all, we need to prepare caching space for Squid, beacuse Squid is a "caching" proxy :)
  Find "Hard Disk Cache Size" under "Squid Hard Disk Cache Settings". I set it to 500MB, but you can choose whatever size.
  The size depends on number of users using the proxy and amount of traffic, that they generate.
  Other setting can be left on default settings.
  Click on "Save" button on the bottom of the page. Squid will prepare the cache partition.
  Wait, until the page finishes loading.

>>General tab
  Check "Enable Squid Proxy", "Keep Settings/Data".
  Proxy Interfaces: WAN, loopback (we have only one interface, but normally you want to select only LAN and loopback)
  Proxy port: we can leave it blank to use default (3128). I changed it to 8118, beacuse I previously ran and had set up Privoxy on other devices and I didn't want to change it on all of them again.
  Check "Allow Users on Interface".
  I didn't enable logging for the sake of stability and performance. But you can enable it int "Logging Settings" section.
  Logs are then availible on "Real Time" tab.
  Click on "Save" button on the bottom of the page.
  Wait, until the page finishes loading.

>>ACLs tab
  In "Allowed Subnets" enter your network address and mask in CIDR format. For me it was "192.168.0.0/25" (without quotes).
  I also created a small blacklist for blocking ads. Enter this into the "Blacklist" box:
  
.googlesyndication.com
.crashlytics.com
.google-analytics.com
.googleusercontent.com
.doubleclick.net
.adskeeper.co.uk
.bet365.com
.addthis.com
.liveadexchanger.com
.ad.
.ads.
  
  In category "Squid Allowed Ports" into box "ACL SafePorts" enter:
    80 443 22
  and for "ACL SSLPorts":
    443 22
  
  Click on "Save" button on the bottom of the page.
  Wait, until the page finishes loading.
----------------------------------
Test Squid
----------------------------------
  Firefox
  Opera
  Windows
  Linux


####################################################
SQUIDGUARD
####################################################
  SquidGuard URL filter for Squid, beacuse in pfSense Squid alone is not able to filter
  (large number of) URLs (sadly).

----------------------------------
Install SquidGuard
----------------------------------
  "System->Package Manager->Availible Packages" and in the "Search Term" box enter "squidGuard"
  and press Enter. Then install package "squidGuard". Confirm.

----------------------------------
Configure SquidGuard package
----------------------------------
  >>General Settings tab
    In "Logging options" section enable "Enable GUI log", "Enable log", "Enable log rotation".
    In "Miscellaneous" section enable "Clean Advertising".
    In "Blacklist options" section enable "Blacklist". In the "Blacklist URL" enter:
      http://www.shallalist.de/Downloads/shallalist.tar.gz
    Click on "Save" button on the bottom of the page.
    Wait, until the page finishes loading.
  
  >>Blacklist tab
    Keep smashing the download button. Literally. It's a bug, that the list will not download after one click on the "Download"
    button. You should also see the blacklist URL in the text field. Keep clicking on the "Download" button until it starts
    downloading it. Just keep clicking ;)
    After the list is installed, go to "Common ACL" tab.
    
  >>Common ACL
    You should see next to "Target Rules" the "Target Rules List". Click on the plus sign.
    Select the categories in "Target Categories", that should be blocked by selecting "deny" in the drop down menu.
    The last category "Default access [all]" set to "allow".
    Enable "Log".
    Click on "Save" button on the bottom of the page.
    Wait, until the page finishes loading.
    
  >>General settings
    Check the "Enable" checkbox to enable SquidGuard. Do the "Update procedure" (explained below).
  
    UPDATE PROCEDURE
    Everytime we change the configuration of Squid or SquidGuardian, the SquidGuard service needs to be restarted.
    In order to do so, we need to perform the "Update procedure", to force the loading of new settings.
      Stepps:
        -Uncheck "Enable SquidGuard". This disables SquidGuard.
        -Click on "Save" button on the bottom of the page. Wait, until the page finishes loading.
        -Click on "Apply" button underneath the checkbox "Enable SquidGuard". Wait, until the page finishes loading.
        -Check "Enable SquidGuard". This enables SquidGuard.
        -Click on "Save" button on the bottom of the page. Wait, until the page finishes loading.
        -Click on "Apply" button underneath the checkbox "Enable SquidGuard". Wait, until the page finishes loading.
    
----------------------------------
Test SquidGuard
----------------------------------
  Use these sites to check, whether ad-blocking is working. Reload the pages with the proxy server enabled and disabled
  to see, if ads are blocked by the proxy server.
    
    https://pi-hole.net/pages-to-test-ad-blocking-performance/#
    engadget.com
    
####################################################
To speed things up
####################################################
  Enable "DNS Resolver" in "Services->DNS Resolver" and check "Enable DNS resolver".
  In "Network Interfaces" choose "All".
  In "Outgoing Network Interfaces" choose "all".
  The rest of the settings we can leave on default.
  Click on "Save" button on the bottom of the page.
  Wait, until the page finishes loading.
  
  The pages should now load faster.
